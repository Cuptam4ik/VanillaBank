<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <title>VanillaPlus</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="images/favicon.png" type="image/png" />
  </head>
  <body>
    <div class="navbar">
      <div class="logo" id="logo">
        <img src="images/logo.png" alt="VanillaPlus Logo" width="48" height="40" style="margin-right: 8px;">
        VanillaPlus
      </div>
      <div
        class="hamburger"
        id="hamburger-btn"
        aria-label="Open menu"
        tabindex="0"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 15 15"
        >
          <path
            fill="currentColor"
            fill-rule="evenodd"
            d="M1.5 3a.5.5 0 0 0 0 1h12a.5.5 0 0 0 0-1zM1 7.5a.5.5 0 0 1 .5-.5h12a.5.5 0 0 1 0 1h-12a.5.5 0 0 1-.5-.5m0 4a.5.5 0 0 1 .5-.5h12a.5.5 0 0 1 0 1h-12a.5.5 0 0 1-.5-.5"
            clip-rule="evenodd"
          />
        </svg>
      </div>
    </div>
    <div class="overlay" id="overlay"></div>

    <!-- Modal for general card operations (2 inputs) -->
    <div class="modal" id="card-op-modal" style="display: none;">
      <div class="modal-content">
        <h2 id="card-op-modal-title" class="modal-title">Операция с картой</h2>
        <input type="number" id="card-op-modal-input1" class="modal-input" placeholder="Введите данные" />
        <input type="number" id="card-op-modal-input2" class="modal-input" placeholder="Введите сумму" />
        <button id="card-op-modal-button" class="modal-button">Подтвердить</button>
        <div id="card-op-modal-status" class="modal-status"></div>
      </div>
    </div>

    <!-- Modal for general card operations (1 input) -->
    <div class="modal" id="card-op-sec-modal" style="display: none;">
      <div class="modal-content">
        <h2 id="card-op-sec-modal-title" class="modal-title">Операция с картой</h2>
        <input type="text" id="card-op-sec-modal-input" class="modal-input" placeholder="" />
        <button id="card-op-sec-modal-button" class="modal-button">Подтвердить</button>
        <div id="card-op-sec-modal-status" class="modal-status"></div>
      </div>
    </div>
    
    <!-- Modal for issuing fines (Inspector) -->
    <div class="modal" id="issue-fine-extended-modal" style="display: none;">
      <div class="modal-content">
        <h2 id="issue-fine-extended-modal-title" class="modal-title">Выдать штраф</h2>
        <input type="number" id="issue-fine-modal-card" class="modal-input" placeholder="Номер карты нарушителя" />
        <input type="number" id="issue-fine-modal-amount" class="modal-input" placeholder="Сумма штрафа" />
        <input type="text" id="issue-fine-modal-reason" class="modal-input" placeholder="Причина (необязательно)" />
        <input type="number" id="issue-fine-modal-days" class="modal-input" placeholder="Срок оплаты (в днях, >0)" />
        <button id="issue-fine-extended-modal-button" class="modal-button">Выдать</button>
        <div id="issue-fine-extended-modal-status" class="modal-status"></div>
      </div>
    </div>

    <!-- Modal for player's fines -->
    <div class="modal" id="player-fines-modal" style="display: none;">
      <div class="modal-content">
        <h2 class="modal-title">Ваши неоплаченные штрафы</h2>
        <div id="player-fines-list" class="fines-list">
          <!-- Штрафы будут загружены сюда -->
        </div>
        <button id="close-fines-modal-btn" class="modal-button gray-button">Закрыть</button>
        <div id="player-fines-modal-status" class="modal-status" style="display: none;"></div>
      </div>
    </div>


    <!-- Auth Modal -->
    <div class="modal" id="auth-modal" style="display: none;">
      <div class="modal-content">
        <h2 class="modal-title">Вход/Регистрация</h2>
        <input type="text" id="auth-username" class="modal-input" placeholder="Введите имя пользователя" />
        <input type="password" id="auth-password" class="modal-input" placeholder="Введите пароль..." />
        <button id="auth-login-button" class="modal-button">Войти</button>
          <button id="auth-reg-button" class="modal-button">Регистрация</button>
        <div id="auth-modal-status" class="modal-status"></div>
      </div>
    </div>

    <div class="color-picker-modal" id="colorPickerModal">
          <div class="color-option" data-color="#EA4242" data-gradient-end="#C0392B">
              <span class="color-name">Красный</span>
          </div>
          <div class="color-option" data-color="#4287F5" data-gradient-end="#2167D0">
              <span class="color-name">Синий</span>
          </div>
          <div class="color-option" data-color="#4CAF50" data-gradient-end="#388E3C">
              <span class="color-name">Зеленый</span>
          </div>
          <div class="color-option" data-color="#9C27B0" data-gradient-end="#7B1FA2">
              <span class="color-name">Фиолетовый</span>
          </div>
          <div class="color-option" data-color="#4DD0E1" data-gradient-end="#00BCD4">
              <span class="color-name">Бирюзовый</span>
          </div>
          <div class="color-option" data-color="#606160" data-gradient-end="#525252">
              <span class="color-name">Серый</span>
          </div>
          <div class="color-option" data-color="#FF9800" data-gradient-end="#F57C00">
              <span class="color-name">Оранжевый</span>
          </div>
    </div>

    <nav class="side-menu" id="side-menu">
      <button id="bank-btn" class="menu">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="currentColor" d="M9.368 1.222a1 1 0 0 0-1.414.15L5.058 5h1.28l2.397-3.004l.77.629L7.575 5h1.288l1.417-1.744l1.718 1.403L11.7 5h.3a3 3 0 0 1 .88.131a1 1 0 0 0-.25-1.245zM3 5.5a.5.5 0 0 1 .5-.5h.558l.795-1H3.5A1.5 1.5 0 0 0 2 5.5v6A2.5 2.5 0 0 0 4.5 14H12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2H3.5a.5.5 0 0 1-.5-.5m7.5 4.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1 0-1"/></svg>
        <span>Банк</span>
      </button>
      <button id="bank-managment-btn" class="menu" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="currentColor" d="M7.292 1.712c.418-.32.999-.32 1.417 0l4.962 3.793c.632.483.293 1.491-.501 1.495H2.83c-.793-.004-1.133-1.012-.5-1.495zM8 5.25a.75.75 0 1 0 0-1.5a.75.75 0 0 0 0 1.5M3.5 8v3H5V8zM6 8v3h1.5V8zm2.5 0v3H10V8zM11 8v3h1.5V8zm-9 5.25c0-.69.56-1.25 1.25-1.25h9.5c.69 0 1.25.56 1.25 1.25v.25a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5z"/></svg>
        <span>Банкирская</span>
      </button>
      <button id="inspector-panel-btn" class="menu" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 20 20"><path fill="currentColor" fill-rule="evenodd" d="M5 2a2 2 0 0 0-2 2v14l3.5-2l3.5 2l3.5-2l3.5 2V4a2 2 0 0 0-2-2zm2.5 3a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0-3m6.207.293a1 1 0 0 0-1.414 0l-6 6a1 1 0 1 0 1.414 1.414l6-6a1 1 0 0 0 0-1.414M12.5 10a1.5 1.5 0 1 0 0 3a1.5 1.5 0 0 0 0-3" clip-rule="evenodd"/></svg>
        <span>Инспекторская</span>
      </button>
      <button id="bank-transactions-btn" class="menu" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="currentColor" d="M10.354 1.646a.5.5 0 0 0-.708.708L11.293 4H3.5a.5.5 0 0 0 0 1h7.793L9.646 6.646a.5.5 0 1 0 .708.708l2.5-2.5a.5.5 0 0 0 0-.708zm-4 7.708a.5.5 0 1 0-.708-.708l-2.5 2.5a.5.5 0 0 0 0 .708l2.5 2.5a.5.5 0 0 0 .708-.708L4.707 12H12.5a.5.5 0 0 0 0-1H4.707z"/></svg>
        <span>Транзакции</span>
      </button>
      <div class="filler"></div>
      <button id="exit-btn" class="menu exit">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 4.001H5v14a2 2 0 0 0 2 2h8m1-5l3-3m0 0l-3-3m3 3H9"/></svg>
         <span>Выход</span>
      </button>
    </nav>
    <main class="main-content" id="main-content">
      <div class="centered-div" id="welcome-div">
          <div class="additional-info">play.bixland.ru 1.21.4+</div>
      </div>
      <div id="bank-page">
        <canvas id="stars"></canvas>
        <div class="bank-main">
          <div class="card" id="card">
            <div class="card-header">
                <span id="card-holder">Mr. Test</span>
                <div class="filler"></div>
                <span id="card-edit-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="shadow-icon"><path fill="currentColor" d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83l3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75z"/></svg>
                </span>
            </div>
            <div class="card-body"></div>
            <div class="card-footer">
              <div class="card-balance-div">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 512 512" class="shadow-icon"><path fill="currentColor" d="M440.9 136.3a4 4 0 0 0 0-6.91L288.16 40.65a64.14 64.14 0 0 0-64.33 0L71.12 129.39a4 4 0 0 0 0 6.91L254 243.88a4 4 0 0 0 4.06 0ZM54 163.51a4 4 0 0 0-6 3.49v173.89a48 48 0 0 0 23.84 41.39L234 479.51a4 4 0 0 0 6-3.46V274.3a4 4 0 0 0-2-3.46ZM272 275v201a4 4 0 0 0 6 3.46l162.15-97.23A48 48 0 0 0 464 340.89V167a4 4 0 0 0-6-3.45l-184 108a4 4 0 0 0-2 3.45"/></svg>
                    <span id="card-balance"> 1000 аб</span>
              </div>
              <span id="card-number">12343</span>
            </div>
          </div>
        <div class="bank-operations">
             <button id="card-send-btn" class="action">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M3 20v-6l8-2l-8-2V4l19 8z"/></svg>
                Перевод по карте 
            </button>
             <button id="player-fines-btn" class="action">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8s-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
              Штрафы 
              <span id="fines-notification-dot" class="notification-dot" style="display:none;">!</span>
            </button>
        </div>
        </div>
        <div class="bank-personal-transactions">
            <h3 class="transaction-page-title row-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M13.26 3C8.17 2.86 4 6.95 4 12H2.21c-.45 0-.67.54-.35.85l2.79 2.8c.2.2.51.2.71 0l2.79-2.8a.5.5 0 0 0-.36-.85H6c0-3.9 3.18-7.05 7.1-7c3.72.05 6.85 3.18 6.9 6.9c.05 3.91-3.1 7.1-7 7.1c-1.61 0-3.1-.55-4.28-1.48a.994.994 0 0 0-1.32.08c-.42.42-.39 1.13.08 1.49A8.86 8.86 0 0 0 13 21c5.05 0 9.14-4.17 9-9.26c-.13-4.69-4.05-8.61-8.74-8.74m-.51 5c-.41 0-.75.34-.75.75v3.68c0 .35.19.68.49.86l3.12 1.85c.36.21.82.09 1.03-.26c.21-.36.09-.82-.26-1.03l-2.88-1.71v-3.4c0-.4-.34-.74-.75-.74"/></svg>
              <span>История операций</span>
            </h2>
            <div id="personal-transaction-list" class="transaction-list">
            </div>
        </div>
      </div>
       <div id="bank-management-page" style="display: none;">
           <button id="check-balance-btn" class="action">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"/></svg>
            <span>Посмотреть баланс</span></button>
           <button id="card-deposit-btn" class="action">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15 20H9v-8H4.16L12 4.16L19.84 12H15z"/></svg>
            Пополнить</button>
           <button id="card-withdraw-btn" class="action">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M9 4h6v8h4.84L12 19.84L4.16 12H9z"/></svg>
            Списать</button>
           <button id="add-banker-btn" class="action" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4m-9-4V7H4v3H1v2h3v3h2v-3h3v-2m6 2a4 4 0 0 0 4-4a4 4 0 0 0-4-4a4 4 0 0 0-4 4a4 4 0 0 0 4 4"/></svg>
            Назначить банкира</button>
           <button id="remove-banker-btn" class="action" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15 14c2.67 0 8 1.33 8 4v2H7v-2c0-2.67 5.33-4 8-4m0-2a4 4 0 0 1-4-4a4 4 0 0 1 4-4a4 4 0 0 1 4 4a4 4 0 0 1-4 4M5 9.59l2.12-2.13l1.42 1.42L6.41 11l2.13 2.12l-1.42 1.42L5 12.41l-2.12 2.13l-1.42-1.42L3.59 11L1.46 8.88l1.42-1.42z"/></svg>
            Уволить банкира</button>
           <button id="add-inspector-btn" class="action" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15 14c-2.67 0-8 1.33-8 4v2h16v-2c0-2.67-5.33-4-8-4m-9-4V7H4v3H1v2h3v3h2v-3h3v-2m6 2a4 4 0 0 0 4-4a4 4 0 0 0-4-4a4 4 0 0 0-4 4a4 4 0 0 0 4 4"/></svg>
            Назначить инспектора</button>
           <button id="remove-inspector-btn" class="action" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15 14c2.67 0 8 1.33 8 4v2H7v-2c0-2.67 5.33-4 8-4m0-2a4 4 0 0 1-4-4a4 4 0 0 1 4-4a4 4 0 0 1 4 4a4 4 0 0 1-4 4M5 9.59l2.12-2.13l1.42 1.42L6.41 11l2.13 2.12l-1.42 1.42L5 12.41l-2.12 2.13l-1.42-1.42L3.59 11L1.46 8.88l1.42-1.42z"/></svg>
            Снять инспектора</button>
       </div>
       <div id="inspector-page" style="display: none;">
           <button id="issue-fine-btn" class="action">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M15 2H9c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2M9 4h6v2H9zm6 16H9v-2h6zm-3-4c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1m0-4c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1m0-4c-.55 0-1-.45-1-1s.45-1 1-1s1 .45 1 1s-.45 1-1 1"/></svg>
            Выдать штраф</button>
           
           <div class="overdue-fines-section">
                <h3 class="transaction-title">Просроченные штрафы (выданные вами):</h3>
                <div id="inspector-overdue-fines-list" class="transaction-list">
                    <!-- Сюда будут загружаться просроченные штрафы -->
                    <div class="info">Нет просроченных штрафов.</div>
                </div>
            </div>
       </div>
       <div id="bank-transactions-page" style="display: none;">
           <h2 class="transaction-title">Все транзакции</h2>
           <div id="transaction-list" class="transaction-list">
           </div>
       </div>
    </main>
    <script>
      const hamburgerBtn = document.getElementById("hamburger-btn");
      const sideMenu = document.getElementById("side-menu");
      const overlay = document.getElementById("overlay");
      const logo = document.getElementById("logo");

      // Menu buttons
      const bankBtn = document.getElementById("bank-btn"); 
      const bankManagmentBtn = document.getElementById("bank-managment-btn"); 
      const inspectorPanelBtn = document.getElementById("inspector-panel-btn"); 
      const transactionsBtn = document.getElementById("bank-transactions-btn"); 
      const exitBtn = document.getElementById("exit-btn");
      
      // Page divs
      const welcomeDiv = document.getElementById("welcome-div");
      const bankPage = document.getElementById("bank-page"); 
      const bankManagementPage = document.getElementById("bank-management-page"); 
      const inspectorPage = document.getElementById("inspector-page"); 
      const bankTransactionsPage = document.getElementById("bank-transactions-page"); 
      
      // --- Modals & Their Content ---
      // Auth Modal
      const authModal = document.getElementById("auth-modal");
      const authUsernameInput = document.getElementById("auth-username");
      const authPasswordInput = document.getElementById("auth-password");
      const authLoginButton = document.getElementById("auth-login-button");
      const authRegButton = document.getElementById("auth-reg-button");
      const authModalStatus = document.getElementById("auth-modal-status");

      // Card Operation Modal (2 inputs)
      const cardOpModal = document.getElementById("card-op-modal");
      const cardOpModalTitle = document.getElementById("card-op-modal-title");
      const cardOpModalInput1 = document.getElementById("card-op-modal-input1");
      const cardOpModalInput2 = document.getElementById("card-op-modal-input2");
      const cardOpModalButton = document.getElementById("card-op-modal-button");
      const cardOpModalStatus = document.getElementById("card-op-modal-status");

      // Card Operation Secondary Modal (1 input)
      const cardOpSecModal = document.getElementById("card-op-sec-modal");
      const cardOpSecModalTitle = document.getElementById("card-op-sec-modal-title");
      const cardOpSecModalInput = document.getElementById("card-op-sec-modal-input");
      const cardOpSecModalButton = document.getElementById("card-op-sec-modal-button");
      const cardOpSecModalStatus = document.getElementById("card-op-sec-modal-status");
      
      // Issue Fine Extended Modal (Inspector)
      const issueFineExtendedModal = document.getElementById("issue-fine-extended-modal");
      const issueFineModalCardInput = document.getElementById("issue-fine-modal-card");
      const issueFineModalAmountInput = document.getElementById("issue-fine-modal-amount");
      const issueFineModalReasonInput = document.getElementById("issue-fine-modal-reason");
      const issueFineModalDaysInput = document.getElementById("issue-fine-modal-days");
      const issueFineExtendedModalButton = document.getElementById("issue-fine-extended-modal-button");
      const issueFineExtendedModalStatus = document.getElementById("issue-fine-extended-modal-status");

      // Player Fines Modal
      const playerFinesModal = document.getElementById("player-fines-modal");
      const playerFinesListDiv = document.getElementById("player-fines-list");
      const closeFinesModalBtn = document.getElementById("close-fines-modal-btn");
      const playerFinesModalStatus = document.getElementById("player-fines-modal-status");


      // --- Action Buttons ---
      // Player Actions
      const cardSendBtn = document.getElementById("card-send-btn");
      const playerFinesBtn = document.getElementById("player-fines-btn"); // Button to open fines modal
      const finesNotificationDot = document.getElementById("fines-notification-dot");
      
      // Banker/Admin Actions (on bank-management-page)
      const cardDepositBtn = document.getElementById("card-deposit-btn");
      const cardWithdrawBtn = document.getElementById("card-withdraw-btn");
      const addBankerBtn = document.getElementById("add-banker-btn");
      const removeBankerBtn = document.getElementById("remove-banker-btn");
      const addInspectorBtn = document.getElementById("add-inspector-btn");
      const removeInspectorBtn = document.getElementById("remove-inspector-btn");
      const checkBalanceBtn = document.getElementById("check-balance-btn");

      // Inspector Actions (on inspector-page)
      const issueFineBtn = document.getElementById("issue-fine-btn"); // Button to open issue fine modal
      const inspectorOverdueFinesListDiv = document.getElementById("inspector-overdue-fines-list");


      // Card information elements
      const cardBalanceSpan = document.getElementById("card-balance");
      const cardNumberSpan = document.getElementById("card-number");
      const cardHolderSpan = document.getElementById("card-holder");
      
      const cardSection = document.getElementById('card');
      const editCardButton = document.getElementById('card-edit-btn');
      const colorPickerModal = document.getElementById('colorPickerModal');
      const colorOptions = document.querySelectorAll('.color-option');

      let menuOpened = false;
      let currentUser = null; // { nickname, balance, isAdmin, isBanker, isInspector, cardNumber, unpaidFinesCount }
      
      checkSession();

      async function checkSession() {
        try {
            const res = await fetch('/api/profile');
            if (res.status === 401) {
                showAuthModal();
            } else if (res.ok) {
                const data = await res.json();
                if (data.user) {
                    currentUser = data.user;
                    updateUIForUser(); 
                    updateUIForRole();  
                } else { // Should not happen if res.ok
                    showAuthModal();
                }
            } else {
                const errorData = await res.json().catch(() => ({ error: "Ошибка получения профиля" }));
                console.error("Profile check error:", res.status, errorData.error);
                showAuthModal(); 
            }
        } catch (err) {
            console.error("Network error during session check:", err);
            showAuthModalStatus("Сетевая ошибка. Попробуйте позже.", true);
            showAuthModal();
        }
      }
      
      function showAuthModal() {
        authModal.style.display = "flex";
        overlay.classList.add("show");
      }

      function closeAuthModal() {
        authModal.style.display = "none";
        authUsernameInput.value = "";
        authPasswordInput.value = "";
        authModalStatus.textContent = "";
        authModalStatus.style.display = "none";
        overlay.classList.remove("show");
      }

      function showAuthModalStatus(message, isError = false) {
        authModalStatus.textContent = message;
        authModalStatus.style.color = isError ? "#FB4848" : "#4CAF50";
        authModalStatus.style.display = "block";
      }

      authLoginButton.addEventListener("click", async () => {
        const nickname = authUsernameInput.value.trim();
        const password = authPasswordInput.value.trim();

        if (!nickname || !password) {
          showAuthModalStatus("Пожалуйста, заполните все поля.", true);
          return;
        }
        showAuthModalStatus("Вход...");
        const data = await apiCall("/api/login", "POST", {nickname, password});
        if (data && data.user) {
          currentUser = data.user;
          updateUIForUser();
          updateUIForRole();
          closeAuthModal();
        } else {
          showAuthModalStatus(data?.message || "Ошибка входа", true);
        }
      });

      authRegButton.addEventListener("click", async () => {
        const nickname = authUsernameInput.value.trim();
        const password = authPasswordInput.value.trim();

        if (!nickname || !password) {
          showAuthModalStatus("Пожалуйста, заполните все поля.", true);
          return;
        }
        showAuthModalStatus("Регистрация...");
        const data = await apiCall("/api/register", "POST", {nickname, password});
        if (data && data.user) {
          currentUser = data.user;
          updateUIForUser();
          updateUIForRole();
          closeAuthModal();
        } else {
           showAuthModalStatus(data?.message || "Ошибка регистрации", true);
        }
      });

      exitBtn.addEventListener("click", async () => {
        await apiCall('/api/logout', 'POST');
        currentUser = null;
        updateUIForUser();
        updateUIForRole();
        closeAllPages();
        closeMenu();
        welcomeDiv.style.display = "flex"; // Show welcome page after logout
        showAuthModal();
      });

      function updateUIForUser() {
        if (currentUser) {
          cardBalanceSpan.textContent = `${currentUser.balance} аб`;
          cardNumberSpan.textContent = currentUser.cardNumber || "N/A";
          cardHolderSpan.textContent = currentUser.nickname || "N/A";
          if (currentUser.unpaidFinesCount > 0) {
            finesNotificationDot.style.display = "inline-block";
            finesNotificationDot.textContent = currentUser.unpaidFinesCount;
          } else {
            finesNotificationDot.style.display = "none";
          }
        } else {
          cardBalanceSpan.textContent = "0 аб";
          cardNumberSpan.textContent = "N/A";
          cardHolderSpan.textContent = "N/A";
          finesNotificationDot.style.display = "none";
        }
        let gradient = getGradientFromLocalStorage();
        if (gradient) {
           setCardGradient(gradient.startColor, gradient.endColor);
        } else {
           setCardGradient("#EA4242", "#C0392B"); 
        }
      }

      function updateUIForRole() {
          bankManagmentBtn.style.display = "none";
          inspectorPanelBtn.style.display = "none";
          transactionsBtn.style.display = "none"; 
          
          addBankerBtn.style.display = "none";
          removeBankerBtn.style.display = "none";
          addInspectorBtn.style.display = "none";
          removeInspectorBtn.style.display = "none";

          if (!currentUser) return; 

          const isAdmin = currentUser.isAdmin;
          const isBanker = currentUser.isBanker;
          const isInspector = currentUser.isInspector;

          if (isBanker || isAdmin) {
              bankManagmentBtn.style.display = "flex"; 
              transactionsBtn.style.display = "flex";   
          }
          if (isInspector || isAdmin) { // Admin can also access inspector panel for testing/oversight
              inspectorPanelBtn.style.display = "flex";
          }
          
          if (isAdmin) {
              addBankerBtn.style.display = "flex";
              removeBankerBtn.style.display = "flex";
              addInspectorBtn.style.display = "flex";
              removeInspectorBtn.style.display = "flex";
          }
      }

    async function loadTransactions(parent, endpoint, personal) {
        parent.innerHTML = ''; // Очистка списка транзакций
        try {
            const res = await fetch(endpoint, { credentials: 'include' });
            if (!res.ok) {
                parent.innerHTML = '<div class="error">Ошибка загрузки транзакций</div>';
                return;
            }
            data = await res.json();
            console.log(data); 
            if (data === undefined) {
                parent.innerHTML = '<div class="error">Нет данных о транзакциях</div>';
                return;
            }
            if (data.length === 0) {
                parent.innerHTML = '<div class="info">Транзакций нет</div>';
                return;
            }
            parent.innerHTML += `<div class="transaction-item">
                    ${ personal ? "" : "<span>ID</span>" }
                    <span>Тип операции</span>
                    <span>Количество</span>
                    <span>Дата и время</span>
                    <span>Отправитель</span>
                    <div></div>
                    <span>Получатель</span>
                </div>`;

            data.forEach(tx => {
                const bankSvg = `<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16"><path fill="currentColor" d="M7.292 1.712c.418-.32.999-.32 1.417 0l4.962 3.793c.632.483.293 1.491-.501 1.495H2.83c-.793-.004-1.133-1.012-.5-1.495zM8 5.25a.75.75 0 1 0 0-1.5a.75.75 0 0 0 0 1.5M3.5 8v3H5V8zM6 8v3h1.5V8zm2.5 0v3H10V8zM11 8v3h1.5V8zm-9 5.25c0-.69.56-1.25 1.25-1.25h9.5c.69 0 1.25.56 1.25 1.25v.25a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5z"/></svg></div>`;
                const arrowSvg = `<div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M24 12.16L18.24 6.4v4.24H0v3.04h18.24v4.24z"/></svg></div>`;
                
                if(tx.sender !== null && tx.sender.nickname === currentUser.nickname) {
                    tx.sender.nickname = "Вы";
                }
                if(tx.receiver !== null && tx.receiver.nickname === currentUser.nickname) {
                    tx.receiver.nickname = "Вы";
                }
                
                const sender = tx.sender || null;
                const senderString = sender !== null ? `<div>
                        <span class="transaction-sender">${sender.nickname}</span>
                        <span class="transaction-card-number">${sender.cardNumber}</span>
                    </div>` : bankSvg;
                
                const receiver = tx.receiver || null;
                const receiverString = receiver !== null ? `<div>
                        <span class="transaction-receiver">${receiver.nickname}</span>
                        <span class="transaction-card-number">${receiver.cardNumber}</span>
                    </div>` : bankSvg;


                const idString = personal ? "" : `<span>${tx.id}</span>`
                let color = tx.type === "DEPOSIT" ? "#4CAF50" : tx.type === "WITHDRAWAL" ? "#F44336" : "white";
                let amount = tx.amount;
                if(tx.type === "TRANSFER" && personal) {
                  if(tx.sender.nickname === "Вы"){
                       amount = "-" + amount;
                      color = "#F44336"; 
                  }
                  else {
                    amount = "+" + amount;
                     color = "#4CAF50";
                  }
                }
                else if(tx.type === "DEPOSIT"){
                    amount = "+" + amount;
                    color = "#4CAF50";
                }
                else if(tx.type === "WITHDRAWAL"){
                    amount = "-" + amount;
                    color = "#F44336";
                }

                const item = `<div class="transaction-item">
                    ${idString}
                    <span class="transaction-type">${getLocaleTransactionType(tx.type)}</span>
                    <span class="transaction-amount" style="color: ${color};">${amount} аб</span>
                    <span class="transaction-date">${formatDateTimeWithoutSeconds(tx.createdAt)}</span>
                    ${senderString}
                    ${arrowSvg}
                    ${receiverString}
                </div>`;
                parent.innerHTML += item;
            });
        } catch (e) {
            parent.innerHTML = '<div class="error">Ошибка загрузки</div>';
            console.error("Ошибка загрузки транзакций:", e);
        }
    }
    
      function toggleMenu() {
        if (menuOpened) closeMenu();
        else openMenu();
      }

      function openMenu() {
        sideMenu.classList.add("open");
        overlay.classList.add("show");
        menuOpened = true;
      }

      function closeMenu() {
        sideMenu.classList.remove("open");
        overlay.classList.remove("show");
        menuOpened = false;
      }

      function closeAllPages() {
        welcomeDiv.style.display = "none";
        bankPage.style.display = "none";
        bankManagementPage.style.display = "none";
        inspectorPage.style.display = "none";
        bankTransactionsPage.style.display = "none";
        document.body.classList.remove("body-gray");
      }
      
      // --- Generic Modal Handlers (Two Inputs) ---
      function showTwoInputsModal(title, ph1, ph2, btnText, callback, input1Type = 'number', input2Type = 'number') {
        cardOpModalTitle.textContent = title;
        cardOpModalInput1.placeholder = ph1;
        cardOpModalInput1.type = input1Type;
        cardOpModalInput2.placeholder = ph2;
        cardOpModalInput2.type = input2Type;
        cardOpModalButton.textContent = btnText;
        cardOpModal.style.display = "flex";
        overlay.classList.add("show");
        cardOpModalButton.onclick = () => callback(cardOpModalInput1.value, cardOpModalInput2.value);
      }
      function closeTwoInputsModal() {
        cardOpModal.style.display = "none";
        cardOpModalInput1.value = ""; cardOpModalInput2.value = "";
        cardOpModalStatus.textContent = ""; cardOpModalStatus.style.display = "none";
        overlay.classList.remove("show");
      }
      function showTwoInputModalStatus(message, isError = false) {
        cardOpModalStatus.textContent = message;
        cardOpModalStatus.style.color = isError ? "#FB4848" : "#4CAF50";
        cardOpModalStatus.style.display = "block";
      }
      cardOpModal.addEventListener("click", (e) => { if (e.target === cardOpModal) closeTwoInputsModal(); });

      // --- Generic Modal Handlers (One Input) ---
      function showSingleInputModal(title, ph, btnText, callback, inputType = 'number') {
        cardOpSecModalTitle.textContent = title;
        cardOpSecModalInput.placeholder = ph;
        cardOpSecModalInput.type = inputType;
        cardOpSecModalButton.textContent = btnText;
        cardOpSecModal.style.display = "flex";
        overlay.classList.add("show");
        cardOpSecModalButton.onclick = () => callback(cardOpSecModalInput.value);
      }
      function closeSingleInputModal() {
        cardOpSecModal.style.display = "none";
        cardOpSecModalInput.value = "";
        cardOpSecModalStatus.textContent = ""; cardOpSecModalStatus.style.display = "none";
        overlay.classList.remove("show");
      }
      function showSingleInputModalStatus(message, isError = false) {
        cardOpSecModalStatus.textContent = message;
        cardOpSecModalStatus.style.color = isError ? "#FB4848" : "#4CAF50";
        cardOpSecModalStatus.style.display = "block";
      }
      cardOpSecModal.addEventListener("click", (e) => { if (e.target === cardOpSecModal) closeSingleInputModal(); });

      // --- Player Action Button Handlers ---
      cardSendBtn.addEventListener("click", () => {
        if (!currentUser) { alert("Сначала войдите в систему."); return; }
        showTwoInputsModal("Перевод по карте", "Номер карты получателя", "Сумма перевода", "Отправить",
          async (receiverCardNumber, amountStr) => {
            const amount = parseInt(amountStr, 10);
            if (!receiverCardNumber || !amount || amount <= 0) {
                showTwoInputModalStatus('Введите корректные данные.', true); return;
            }
            showTwoInputModalStatus('Обработка...');
            const data = await apiCall('/api/player/transfer', 'POST', {
                senderCardNumber: currentUser.cardNumber, receiverCardNumber, amount
            });
            if (data) {
                showTwoInputModalStatus(data.message, !data.senderBalance);
                if (data.senderBalance !== undefined) {
                    currentUser.balance = data.senderBalance;
                    updateUIForUser();
                    setTimeout(closeTwoInputsModal, 2000);
                }
            } else {
                showTwoInputModalStatus(data?.message || "Ошибка перевода.", true);
            }
          }
        );
      });

      playerFinesBtn.addEventListener("click", () => {
        if (!currentUser) { alert("Сначала войдите в систему."); return; }
        openPlayerFinesModal();
      });

      async function openPlayerFinesModal() {
        playerFinesModalStatus.style.display = "none";
        playerFinesListDiv.innerHTML = '<div class="info">Загрузка штрафов...</div>';
        playerFinesModal.style.display = "flex";
        overlay.classList.add("show");

        const fines = await apiCall('/api/player/my-fines', 'GET');
        if (!fines) {
            playerFinesListDiv.innerHTML = '<div class="error">Не удалось загрузить штрафы.</div>';
            return;
        }
        if (fines.length === 0) {
            playerFinesListDiv.innerHTML = '<div class="info">У вас нет неоплаченных штрафов.</div>';
            return;
        }
        playerFinesListDiv.innerHTML = '';
        fines.forEach(fine => {
            const fineItem = document.createElement('div');
            fineItem.className = 'fine-item';
            fineItem.innerHTML = `
                <div class="fine-details">
                    <span class="fine-amount">${fine.amount} аб</span>
                    <span>Причина: ${fine.reason || 'Не указана'}</span>
                    <span>Выписал: ${fine.inspector.nickname} (${fine.inspector.cardNumber})</span>
                    <span class="fine-duedate">Оплатить до: ${formatDateTimeWithoutSeconds(fine.dueDate)}</span>
                </div>
                <button class="pay-fine-btn" data-fine-id="${fine.id}">Оплатить</button>
            `;
            fineItem.querySelector('.pay-fine-btn').addEventListener('click', async () => {
                await handlePayFine(fine.id);
            });
            playerFinesListDiv.appendChild(fineItem);
        });
      }

      async function handlePayFine(fineId) {
        playerFinesModalStatus.textContent = "Оплата...";
        playerFinesModalStatus.style.display = "block";
        playerFinesModalStatus.style.color = "#4CAF50";

        const data = await apiCall(`/api/player/pay-fine/${fineId}`, 'POST');
        if (data) {
            playerFinesModalStatus.textContent = data.message;
            if (data.newBalance !== undefined) {
                currentUser.balance = data.newBalance;
                currentUser.unpaidFinesCount = data.unpaidFinesCount;
                updateUIForUser();
                openPlayerFinesModal(); // Refresh list
            }
        } else {
            playerFinesModalStatus.textContent = data?.message || "Ошибка оплаты штрафа.";
            playerFinesModalStatus.style.color = "#FB4848";
        }
      }
      closeFinesModalBtn.addEventListener("click", () => {
        playerFinesModal.style.display = "none";
        overlay.classList.remove("show");
      });
      playerFinesModal.addEventListener("click", (e) => { if (e.target === playerFinesModal) closeFinesModalBtn.click(); });


      // --- Banker/Admin Action Button Handlers ---
      cardDepositBtn.addEventListener("click", () => {
        if (!currentUser || (!currentUser.isBanker && !currentUser.isAdmin)) { alert("Нет доступа."); return; }
        showTwoInputsModal("Пополнение карты", "Номер карты для пополнения", "Сумма", "Пополнить",
          async (targetCardNumber, amountStr) => {
              const amount = parseInt(amountStr, 10);
              if (!targetCardNumber || !amount || amount <= 0) { showTwoInputModalStatus('Неверные данные.', true); return; }
              showTwoInputModalStatus('Обработка...');
              const data = await apiCall('/api/banker/deposit', 'POST', { targetCardNumber, amount });
              if (data) {
                  showTwoInputModalStatus(data.message);
                  if (parseInt(targetCardNumber) === currentUser.cardNumber) { // Check if self-deposit
                      currentUser.balance += amount; // Update balance
                      updateUIForUser();
                  }
                  setTimeout(closeTwoInputsModal, 2000);
              } else {
                 showTwoInputModalStatus(data?.message || "Ошибка пополнения.", true);
              }
          }
        );
      });

      cardWithdrawBtn.addEventListener("click", () => {
        if (!currentUser || (!currentUser.isBanker && !currentUser.isAdmin)) { alert("Нет доступа."); return; }
        showTwoInputsModal("Списание с карты", "Номер карты для списания", "Сумма", "Списать",
          async (targetCardNumber, amountStr) => {
            const amount = parseInt(amountStr, 10);
            if (!targetCardNumber || !amount || amount <= 0) { showTwoInputModalStatus('Неверные данные.', true); return; }
            showTwoInputModalStatus('Обработка...');
            const data = await apiCall('/api/banker/withdraw', 'POST', { targetCardNumber, amount });
            if (data) {
                showTwoInputModalStatus(data.message);
                if (parseInt(targetCardNumber) === currentUser.cardNumber) {
                    currentUser.balance -= amount; // Update balance if self-withdrawal
                    updateUIForUser();
                }
                 setTimeout(closeTwoInputsModal, 2000);
            } else {
                showTwoInputModalStatus(data?.message || "Ошибка списания.", true);
            }
          }
        );
      });
      
      checkBalanceBtn.addEventListener("click", () => {
        if (!currentUser || (!currentUser.isBanker && !currentUser.isAdmin)) { alert("Нет доступа."); return; }
        showSingleInputModal("Проверка баланса", "Номер карты игрока", "Проверить",
          async (targetCardNumber) => {
            if (!targetCardNumber) { showSingleInputModalStatus("Введите номер карты.", true); return;}
            showSingleInputModalStatus('Проверка...');
            const data = await apiCall('/api/banker/balance', 'POST', { targetCardNumber });
            if (data) {
                showSingleInputModalStatus(`Баланс ${data.nickname} (${data.cardNumber}): ${data.balance} аб`);
            } else {
                showSingleInputModalStatus(data?.message || "Ошибка получения баланса.", true);
            }
          }
        );
      });
      
      // --- Admin Role Management Buttons ---
      addBankerBtn.addEventListener("click", () => {
        if (!currentUser || !currentUser.isAdmin) { alert("Нет доступа."); return; }
        showSingleInputModal("Назначить банкира", "Номер карты игрока", "Назначить",
          async (targetCardNumber) => {
            if (!targetCardNumber) { showSingleInputModalStatus("Введите номер карты.", true); return;}
            showSingleInputModalStatus('Назначение...');
            const data = await apiCall('/api/admin/add-banker', 'POST', { targetCardNumber });
            showSingleInputModalStatus(data?.message || "Ошибка.", !data);
            if (data && parseInt(targetCardNumber) === currentUser.cardNumber) { currentUser.isBanker = true; updateUIForRole(); } 
          }
        );
      });
      removeBankerBtn.addEventListener("click", () => {
        if (!currentUser || !currentUser.isAdmin) { alert("Нет доступа."); return; }
        showSingleInputModal("Снять роль банкира", "Номер карты игрока", "Снять роль",
          async (targetCardNumber) => {
             if (!targetCardNumber) { showSingleInputModalStatus("Введите номер карты.", true); return;}
             showSingleInputModalStatus('Снятие роли...');
             const data = await apiCall('/api/admin/remove-banker', 'POST', { targetCardNumber });
             showSingleInputModalStatus(data?.message || "Ошибка.", !data);
             if (data && parseInt(targetCardNumber) === currentUser.cardNumber) { currentUser.isBanker = false; updateUIForRole(); }
          }
        );
      });
      addInspectorBtn.addEventListener("click", () => {
        if (!currentUser || !currentUser.isAdmin) { alert("Нет доступа."); return; }
        showSingleInputModal("Назначить инспектора", "Номер карты игрока", "Назначить",
          async (targetCardNumber) => {
            if (!targetCardNumber) { showSingleInputModalStatus("Введите номер карты.", true); return;}
            showSingleInputModalStatus('Назначение...');
            const data = await apiCall('/api/admin/add-inspector', 'POST', { targetCardNumber });
            showSingleInputModalStatus(data?.message || "Ошибка.", !data);
            if (data && parseInt(targetCardNumber) === currentUser.cardNumber) { currentUser.isInspector = true; updateUIForRole(); }
          }
        );
      });
      removeInspectorBtn.addEventListener("click", () => {
        if (!currentUser || !currentUser.isAdmin) { alert("Нет доступа."); return; }
        showSingleInputModal("Снять роль инспектора", "Номер карты игрока", "Снять роль",
          async (targetCardNumber) => {
            if (!targetCardNumber) { showSingleInputModalStatus("Введите номер карты.", true); return;}
            showSingleInputModalStatus('Снятие роли...');
            const data = await apiCall('/api/admin/remove-inspector', 'POST', { targetCardNumber });
            showSingleInputModalStatus(data?.message || "Ошибка.", !data);
            if (data && parseInt(targetCardNumber) === currentUser.cardNumber) { currentUser.isInspector = false; updateUIForRole(); }
          }
        );
      });
      
      // --- Inspector Action Button Handlers ---
      issueFineBtn.addEventListener("click", () => {
        if (!currentUser || (!currentUser.isInspector && !currentUser.isAdmin) ) { alert("Нет доступа."); return; }
        openIssueFineExtendedModal();
      });

      function openIssueFineExtendedModal() {
        issueFineModalCardInput.value = '';
        issueFineModalAmountInput.value = '';
        issueFineModalReasonInput.value = '';
        issueFineModalDaysInput.value = '';
        issueFineExtendedModalStatus.style.display = "none";
        issueFineExtendedModal.style.display = "flex";
        overlay.classList.add("show");
      }
      issueFineExtendedModalButton.addEventListener("click", async () => {
          const targetCardNumber = issueFineModalCardInput.value.trim();
          const amount = parseInt(issueFineModalAmountInput.value, 10);
          const reason = issueFineModalReasonInput.value.trim();
          const daysUntilDue = parseInt(issueFineModalDaysInput.value, 10);

          if (!targetCardNumber || !amount || amount <= 0 || !daysUntilDue || daysUntilDue <=0) {
              issueFineExtendedModalStatus.textContent = 'Заполните карту, сумму и срок (>0 дней).';
              issueFineExtendedModalStatus.style.color = "#FB4848";
              issueFineExtendedModalStatus.style.display = "block";
              return;
          }
          issueFineExtendedModalStatus.textContent = 'Выписка штрафа...';
          issueFineExtendedModalStatus.style.color = "#4CAF50";
          issueFineExtendedModalStatus.style.display = "block";

          const data = await apiCall('/api/inspector/issue-fine', 'POST', { targetCardNumber, amount, reason, daysUntilDue });
          if (data) {
              issueFineExtendedModalStatus.textContent = data.message;
              setTimeout(() => { // Close modal after a delay on success
                issueFineExtendedModal.style.display = "none";
                overlay.classList.remove("show");
              }, 2500);
          } else {
              issueFineExtendedModalStatus.textContent = data?.message || 'Ошибка при выписке штрафа.';
              issueFineExtendedModalStatus.style.color = "#FB4848";
          }
      });
      issueFineExtendedModal.addEventListener("click", (e) => { 
        if (e.target === issueFineExtendedModal) {
            issueFineExtendedModal.style.display = "none";
            overlay.classList.remove("show");
        }
      });

      async function loadInspectorOverdueFines() {
        if (!currentUser || (!currentUser.isInspector && !currentUser.isAdmin)) return;
        inspectorOverdueFinesListDiv.innerHTML = '<div class="info">Загрузка просроченных штрафов...</div>';
        const fines = await apiCall('/api/inspector/my-overdue-fines', 'GET');

        if (!fines) {
            inspectorOverdueFinesListDiv.innerHTML = '<div class="error">Не удалось загрузить штрафы.</div>';
            return;
        }
        if (fines.length === 0) {
            inspectorOverdueFinesListDiv.innerHTML = '<div class="info">Нет просроченных штрафов, выписанных вами.</div>';
            return;
        }
        inspectorOverdueFinesListDiv.innerHTML = '';
        fines.forEach(fine => {
            const item = `<div class="transaction-item"> <!-- Can reuse transaction-item style -->
                <span class="transaction-type">Просрочен!</span>
                <span class="transaction-amount" style="color: #F44336;">${fine.amount} аб</span>
                <span class="transaction-date">Срок: ${formatDateTimeWithoutSeconds(fine.dueDate)}</span>
                <div><span class="transaction-sender">Кому: ${fine.user.nickname}</span><span class="transaction-card-number">${fine.user.cardNumber}</span></div>
                <div><span class="transaction-receiver">Причина: ${fine.reason || '-'}</span></div>
            </div>`;
            inspectorOverdueFinesListDiv.innerHTML += item;
        });
      }


      // --- Menu Navigation & Page Toggling ---
      hamburgerBtn.addEventListener("click", toggleMenu);
      overlay.addEventListener("click", () => { // Close any open modal or menu on overlay click
        closeMenu();
        closeTwoInputsModal();
        closeSingleInputModal();
        if(playerFinesModal.style.display === 'flex') closeFinesModalBtn.click();
        if(issueFineExtendedModal.style.display === 'flex') {
            issueFineExtendedModal.style.display = "none";
            overlay.classList.remove("show"); // Ensure overlay is hidden
        }
        colorPickerModal.classList.remove('visible');
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
            closeMenu();
            closeTwoInputsModal();
            closeSingleInputModal();
            if(playerFinesModal.style.display === 'flex') closeFinesModalBtn.click();
            if(issueFineExtendedModal.style.display === 'flex') {
                issueFineExtendedModal.style.display = "none";
                overlay.classList.remove("show");
            }
            colorPickerModal.classList.remove('visible');
        }
      });

      bankBtn.addEventListener("click", async () => { 
        if (!currentUser) { showAuthModal(); return; }
        closeAllPages();
        bankPage.style.display = "flex";
        document.body.classList.add("body-gray");
        await loadTransactions(document.getElementById("personal-transaction-list"), "/api/player/transactions", true);
        closeMenu();
      });

      bankManagmentBtn.addEventListener("click", () => { 
        if (!currentUser || (!currentUser.isBanker && !currentUser.isAdmin)) { showAuthModal(); return; }
        closeAllPages();
        bankManagementPage.style.display = "flex";
        document.body.classList.add("body-gray");
        closeMenu();
      });
      
      inspectorPanelBtn.addEventListener("click", async () => { 
        if (!currentUser || (!currentUser.isInspector && !currentUser.isAdmin)) { showAuthModal(); return; }
        closeAllPages();
        inspectorPage.style.display = "flex";
        document.body.classList.add("body-gray");
        await loadInspectorOverdueFines(); // Load overdue fines for inspector
        closeMenu();
      });

      transactionsBtn.addEventListener("click", async () => { 
        if (!currentUser || (!currentUser.isBanker && !currentUser.isAdmin)) { showAuthModal(); return; }
        closeAllPages();
        bankTransactionsPage.style.display = "flex";
        document.body.classList.add("body-gray");
        await loadTransactions(document.getElementById("transaction-list"), "/api/transaction-list"); // Reused function
        closeMenu();
      });

      logo.addEventListener("click", () => {
        closeAllPages();
        welcomeDiv.style.display = "flex"; // Ensure welcome div is visible
        document.body.classList.remove("body-gray");
        closeMenu();
      });

      // --- API Call Helper ---
      async function apiCall(endpoint, method, body) {
        const currentOpenModalStatus = getCurrentOpenModalStatusElement();
        try {
            const response = await fetch(endpoint, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: body ? JSON.stringify(body) : null,
            });
            const data = await response.json(); 
            if (!response.ok) {
                const errorMsg = data.message || data.error || `Ошибка ${response.status}`;
                console.error('API Error:', response.status, errorMsg);
                if (currentOpenModalStatus) {
                    currentOpenModalStatus.textContent = errorMsg;
                    currentOpenModalStatus.style.color = "#FB4848";
                }
                return null; 
            }
            if (currentOpenModalStatus && (method === 'POST' || method === 'PUT' || method === 'DELETE') && data.message) {
                currentOpenModalStatus.textContent = data.message; // Show success message from server
            } else if (currentOpenModalStatus && method !== 'GET') {
                 currentOpenModalStatus.style.display = 'none'; // Hide status if no specific message for non-GET
            }
            return data; 
        } catch (error) {
            console.error('API Call Exception:', error);
            const errorMsg = 'Сетевая ошибка или ошибка сервера.';
            if (currentOpenModalStatus) {
                currentOpenModalStatus.textContent = errorMsg;
                currentOpenModalStatus.style.color = "#FB4848";
            }
            return null;
        }
      }
      function getCurrentOpenModalStatusElement() {
        if (authModal.style.display === 'flex') return authModalStatus;
        if (cardOpModal.style.display === 'flex') return cardOpModalStatus;
        if (cardOpSecModal.style.display === 'flex') return cardOpSecModalStatus;
        if (issueFineExtendedModal.style.display === 'flex') return issueFineExtendedModalStatus;
        if (playerFinesModal.style.display === 'flex') return playerFinesModalStatus;
        return null;
      }

      // --- Utility Functions ---
      function formatDateTimeWithoutSeconds(isoString) {
        if (!isoString) return 'N/A';
        const date = new Date(isoString);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
      }

      function getLocaleTransactionType(type) {
        switch (type) {
            case "DEPOSIT": return "Пополнение";
            case "WITHDRAWAL": return "Списание";
            case "TRANSFER": return "Перевод";
            case "FINE_PAYMENT": return "Оплата штрафа";
            default: return type;
        }
      }

      // --- Card Color Picker ---
      function setCardGradient(startColor, endColor) {
          cardSection.style.background = `linear-gradient(135deg, ${startColor} 0%, ${endColor} 100%)`;
      }
      function saveGradientToLocalStorage(startColor, endColor) {
        localStorage.setItem('cardGradient', JSON.stringify({ startColor, endColor }));
      }
      function getGradientFromLocalStorage() {
        const stored = localStorage.getItem('cardGradient');
        if (stored) {
          try { return JSON.parse(stored); } catch (e) { console.error('Error parsing gradient', e); }
        }
        return null;
      }
      editCardButton.addEventListener('click', (e) => {
          console.log("lok");
          e.stopPropagation(); // Предотвращаем всплытие события, чтобы не закрыть модальное окно сразу
          colorPickerModal.classList.toggle('visible'); // Переключаем видимость модального окна
          console.log(e.clientX + colorPickerModal.clientWidth > window.innerWidth);
          if(e.clientX + colorPickerModal.clientWidth > window.innerWidth){
            colorPickerModal.style.left = `${e.clientX - colorPickerModal.clientWidth - 8}px`; // Устанавливаем позицию модального окна по X
          } else {
                colorPickerModal.style.left = `${e.clientX}px`; // Устанавливаем позицию модального окна по X
          }
          colorPickerModal.style.top = `${e.clientY}px`; // Устанавливаем позицию модального окна по Y
          
      });
      colorOptions.forEach(option => {
          option.addEventListener('click', () => {
              const startColor = option.getAttribute('data-color');
              const endColor = option.getAttribute('data-gradient-end');
              setCardGradient(startColor, endColor);
              saveGradientToLocalStorage(startColor, endColor);
              colorPickerModal.classList.remove('visible');
          });
      });
      document.addEventListener('click', (event) => { // Close color picker on outside click
          if (!colorPickerModal.contains(event.target) && !editCardButton.contains(event.target)) {
              colorPickerModal.classList.remove('visible');
          }
      });

      const starsCanvas = document.getElementById("stars");

      // Make sure welcome div is shown by default if no user or specific page is requested
      if (!currentUser && window.location.hash === '') { // Check if no deep link
          closeAllPages();
          welcomeDiv.style.display = 'flex';
      }
    </script>
    <script src="stars.js"></script>
  </body>
</html>